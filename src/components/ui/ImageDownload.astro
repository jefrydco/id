---
import { Check, Download } from "@lucide/astro";
---

<template id="image-download-icons-template">
  <Download class="download-icon" size={16} />
  <Check class="downloaded-icon" size={16} />
</template>

<script>
  function initImageDownload() {
    const template = document.getElementById('image-download-icons-template')
    const downloadButtons = document.querySelectorAll('.image-download')

    downloadButtons.forEach((button) => {
      if (button.dataset.imageDownloadInit) return
      button.dataset.imageDownloadInit = '1'

      if (!button.querySelector('svg') && template) {
        const icons = template.content.cloneNode(true)
        button.appendChild(icons)
      }

      const wrapper = button.closest('.download-image-wrapper')
      if (!wrapper) return

      const imgElement = wrapper.querySelector('img')
      if (!imgElement) return

      wrapper.addEventListener('mouseenter', () => {
        button.classList.add('visible')
      })

      wrapper.addEventListener('mouseleave', () => {
        if (!button.hasAttribute('data-downloading')) {
          button.classList.remove('visible')
        }
      })

      button.addEventListener('click', async (e) => {
        e.stopPropagation()
        e.preventDefault()

        button.setAttribute('data-downloading', 'true')

        try {
          const imgSrc = imgElement.src
          const response = await fetch(imgSrc)
          const blob = await response.blob()

          const { createDownloadFilename } = await import('@/utils/download-filename')
          const urlParts = imgSrc.split('/')
          const filenameWithParams = urlParts[urlParts.length - 1]
          const originalFilename = filenameWithParams.split('?')[0] || 'image'
          const filename = createDownloadFilename(originalFilename)

          const url = URL.createObjectURL(blob)
          const a = document.createElement('a')
          a.href = url
          a.download = filename
          document.body.appendChild(a)
          a.click()
          document.body.removeChild(a)
          URL.revokeObjectURL(url)

          button.classList.add('downloaded')

          setTimeout(() => {
            if (!wrapper.matches(':hover')) {
              button.classList.remove('visible')
            }
            button.removeAttribute('data-downloading')

            setTimeout(() => {
              button.classList.remove('downloaded')
            }, 500)
          }, 1500)
        } catch (err) {
          console.error('Failed to download image:', err)
          button.removeAttribute('data-downloading')
        }
      })
    })
  }

  document.addEventListener('astro:page-load', initImageDownload)
  document.addEventListener('DOMContentLoaded', initImageDownload)
</script>

<style is:inline>
  .download-image-wrapper {
    position: relative !important;
    display: block;
  }

  .download-image-wrapper figure {
    margin: 0;
  }

  .image-download {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    width: 2rem;
    height: 2rem;
    z-index: 10;
    background: var(--bg);
    border-radius: 0.375rem;
    font-size: 0.75rem;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.15s ease-out;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--border);
    backdrop-filter: blur(48px);
    opacity: 0;
  }

  .image-download.visible,
  .image-download:focus,
  .image-download:focus-visible {
    opacity: 1;
  }

  .image-download::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--code-bg);
    border-radius: 0.325rem;
    opacity: 0;
    transition: opacity 0.15s ease-out;
    pointer-events: none;
  }

  .image-download:hover::before {
    opacity: 1;
  }

  .image-download:hover {
    color: var(--text-primary);
  }

  .image-download:focus,
  .image-download:focus-visible {
    outline: 2px solid var(--focus);
    outline-offset: 2px;
    color: var(--text-primary);
  }

  .image-download svg {
    flex-shrink: 0;
    position: relative;
    z-index: 1;
  }

  .image-download .downloaded-icon {
    display: none;
  }

  .image-download.downloaded .download-icon {
    display: none;
  }

  .image-download.downloaded .downloaded-icon {
    display: block;
  }

  @media (prefers-reduced-motion: reduce) {
    .image-download {
      transition: none;
    }

    .image-download::before {
      transition: none;
    }
  }
</style>
