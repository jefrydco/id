---
import { defaultLocale, getTranslations, type Locale } from "@/i18n";
import type { TOCProps } from "@/types";

interface Props extends TOCProps {
	locale?: Locale;
}

const { toc = [], locale = defaultLocale } = Astro.props;
const t = getTranslations(locale);
---

<div class="toc-container" id="toc" data-pagefind-ignore="all">
  <nav class="toc-nav">
    <ul class="toc-list" id="toc-list">
      <!-- TOC items -->
      {
        toc.map((item) => (
          <li class={`toc-item toc-level-${item.level}`}>
            <a href={`#${item.id}`} class="toc-link" title={item.text} data-text={item.text}>
              {item.text}
            </a>
          </li>
        ))
      }
    </ul>
  </nav>
</div>

<script is:inline>
  ;(function () {
    const CONTENT_WIDTH = 55

    const state = {
      container: null,
      links: null,
      headings: null,
      headingMap: new Map(),
      positions: [],
      scrollTimeout: null,
      hasContent: false
    }

    function initElements() {
      state.container = document.querySelector('.prose > .toc-container')
      if (!state.container) return false

      state.links = document.querySelectorAll('.toc-link')
      state.headings = document.querySelectorAll('h1, h2, h3, h4, h5, h6')

      state.headingMap.clear()
      state.links.forEach((link) => {
        const href = link.getAttribute('href')
        if (href?.startsWith('#')) {
          state.headingMap.set(href.substring(1), link)
        }
      })

      return true
    }

    function checkContent() {
      if (!state.container || !state.links) return

      state.hasContent = state.links.length > 0
    }

    function cachePositions() {
      if (!state.headings?.length) return

      const scrollTop = window.pageYOffset
      state.positions = Array.from(state.headings)
        .filter((_, index) => !(index === 0 && state.headings[0].tagName === 'H1'))
        .map((heading) => ({
          id: heading.id,
          offsetTop: heading.getBoundingClientRect().top + scrollTop
        }))
    }

    function adjustPosition() {
      if (!state.container || !state.hasContent) {
        return
      }

      const pageWidth = window.innerWidth
      const margin = (pageWidth - CONTENT_WIDTH * 16) / 2
      const minSpace = 11 * 16 + 52

      if (margin >= minSpace) {
        state.container.classList.add('fixed-position')
        state.container.style.left = `${margin - 176 - 40}px`
      } else {
        state.container.classList.remove('fixed-position')
        state.container.style.left = ''
      }
    }

    function handleClick(e) {
      const link = e.target.closest('.toc-link')
      if (!link) return

      e.preventDefault()

      const href = link.getAttribute('href')
      if (href?.startsWith('#')) {
        const target = document.getElementById(href.substring(1))
        if (target) {
          const rect = target.getBoundingClientRect()
          const scrollTop = window.pageYOffset || document.documentElement.scrollTop
          const offset = rect.top + scrollTop - 96
          const motionOK = !window.matchMedia('(prefers-reduced-motion: reduce)').matches
          window.scrollTo({ top: offset, behavior: motionOK ? 'smooth' : 'auto' })
          history.pushState(null, null, href)
        }
      }
    }

    function updateActive() {
      if (!state.links?.length || !state.positions.length) return

      const scrollTop = window.pageYOffset + 100
      let currentActive = null

      for (let i = state.positions.length - 1; i >= 0; i--) {
        if (scrollTop >= state.positions[i].offsetTop) {
          currentActive = state.positions[i].id
          break
        }
      }

      state.links.forEach((link) => link.classList.remove('active'))

      if (currentActive && state.headingMap.has(currentActive)) {
        state.headingMap.get(currentActive).classList.add('active')
      }
    }

    function init(retryCount = 0) {
      const maxRetries = 5

      if (initElements()) {
        checkContent()
        adjustPosition()
        cachePositions()

        if (state.container) {
          state.container.removeEventListener('click', handleClick)
          state.container.addEventListener('click', handleClick)
        }

        updateActive()
      } else if (retryCount < maxRetries) {
        setTimeout(() => init(retryCount + 1), 100)
      }
    }

    function handleScroll() {
      if (state.scrollTimeout) {
        cancelAnimationFrame(state.scrollTimeout)
      }
      state.scrollTimeout = requestAnimationFrame(updateActive)
    }

    function handleResize() {
      adjustPosition()
      requestAnimationFrame(cachePositions)
    }

    function cleanup() {
      if (state.scrollTimeout) {
        cancelAnimationFrame(state.scrollTimeout)
        state.scrollTimeout = null
      }

      Object.assign(state, {
        container: null,
        links: null,
        headings: null,
        headingMap: new Map(),
        positions: [],
        hasContent: false
      })
    }

    document.addEventListener('astro:page-load', () => {
      cleanup()
      init()
    })

    document.addEventListener('astro:after-swap', () => {
      cleanup()
      init()
    })

    document.addEventListener('DOMContentLoaded', () => {
      if (!state.container || !state.hasContent) {
        init()
      }
    })

    window.addEventListener('resize', handleResize)
    window.addEventListener('scroll', handleScroll)
  })()
</script>

<style is:inline>
  .toc-container {
    width: 12rem;
    position: relative;
    left: -0.175em;
    opacity: 0;
    transition: opacity 0.2s ease-out;
  }

  .prose > .toc-container {
    display: none;
  }

  .prose > .toc-container.fixed-position {
    display: block;
    opacity: 1;
    position: fixed;
    top: 12rem;
    margin-top: 0;
    padding-left: 1rem;
    z-index: 10;
    left: auto;
    max-height: calc(100vh - 12rem - 2rem);
    overflow-y: auto;
  }

  .toc-nav {
    font-family: var(--sans);
  }

  .toc-list,
  .toc-list li,
  .toc-item {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .prose .toc-container .toc-list {
    margin-left: 0 !important;
    padding-left: 0 !important;
  }

  .prose .toc-container .toc-list li {
    margin: 0 !important;
    padding: 0 !important;
  }

  .toc-item::before,
  .toc-item::marker {
    display: none;
  }

  .toc-link {
    display: block;
    color: transparent;
    text-decoration: none;
    position: relative;
    padding-left: 0;
    height: 1.125rem;
    width: 100%;
    min-height: 1rem;
    font-size: 0;
    line-height: 1.125rem;
    text-indent: 2rem;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
    transition:
      color 0.2s ease-out,
      font-size 0.2s ease-out,
      text-indent 0.2s ease-out;
    cursor: pointer;
  }

  .toc-link::after {
    content: attr(data-text);
    position: absolute;
    left: -0.5rem;
    top: 0;
    font-family: var(--sans);
    font-size: var(--font-size-s);
    letter-spacing: var(--spacing-m);
    line-height: 1.125rem;
    color: var(--text-primary);
    opacity: 0;
    transition:
      opacity 0.2s ease-out,
      left 0.2s ease-out;
    pointer-events: none;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
    max-width: 100%;
  }

  .toc-link:hover::after,
  .toc-link:focus-visible::after {
    opacity: 1;
    left: -0.75rem;
  }

  .toc-link:focus-visible {
    outline: 2px solid var(--focus);
    outline-offset: 2px;
    border-radius: 0.125rem;
  }

  .toc-level-1 .toc-link:hover::before,
  .toc-level-2 .toc-link:hover::before,
  .toc-level-3 .toc-link:hover::before,
  .toc-level-4 .toc-link:hover::before,
  .toc-level-5 .toc-link:hover::before,
  .toc-level-6 .toc-link:hover::before,
  .toc-level-1 .toc-link:focus-visible::before,
  .toc-level-2 .toc-link:focus-visible::before,
  .toc-level-3 .toc-link:focus-visible::before,
  .toc-level-4 .toc-link:focus-visible::before,
  .toc-level-5 .toc-link:focus-visible::before,
  .toc-level-6 .toc-link:focus-visible::before {
    width: 0.75rem;
    transition: width 0.1s ease-out;
  }

  .toc-link.active {
    color: var(--text-primary);
  }

  .toc-level-1 .toc-link::before,
  .toc-level-2 .toc-link::before,
  .toc-level-3 .toc-link::before,
  .toc-level-4 .toc-link::before,
  .toc-level-5 .toc-link::before,
  .toc-level-6 .toc-link::before {
    content: '';
    position: absolute;
    left: 0;
    top: 50%;
    width: 2.5rem;
    height: 1px;
    background-color: var(--text-tertiary);
    transform: translateY(-50%);
    opacity: 0.4;
    transition: all 0.1s ease-out;
  }

  .toc-level-3 .toc-link {
    padding-left: 0.5rem;
  }

  .toc-level-4 .toc-link {
    padding-left: 1rem;
  }

  .toc-level-5 .toc-link {
    padding-left: 1.5rem;
  }

  .toc-level-6 .toc-link {
    padding-left: 2rem;
  }

  .toc-level-3 .toc-link::before {
    left: 0.5rem;
  }

  .toc-level-4 .toc-link::before {
    left: 1rem;
  }

  .toc-level-5 .toc-link::before {
    left: 1.5rem;
  }

  .toc-level-6 .toc-link::before {
    left: 2rem;
  }

  .toc-level-3 .toc-link::after {
    left: 0;
  }

  .toc-level-3 .toc-link:hover::after,
  .toc-level-3 .toc-link:focus-visible::after {
    left: -0.25rem;
  }

  .toc-level-4 .toc-link::after {
    left: 0.5rem;
  }

  .toc-level-4 .toc-link:hover::after,
  .toc-level-4 .toc-link:focus-visible::after {
    left: 0.25rem;
  }

  .toc-level-5 .toc-link::after {
    left: 1rem;
  }

  .toc-level-5 .toc-link:hover::after,
  .toc-level-5 .toc-link:focus-visible::after {
    left: 0.75rem;
  }

  .toc-level-6 .toc-link::after {
    left: 1.5rem;
  }

  .toc-level-6 .toc-link:hover::after,
  .toc-level-6 .toc-link:focus-visible::after {
    left: 1.25rem;
  }

  .toc-link:hover::before,
  .toc-link:focus-visible::before,
  .toc-link.active::before {
    opacity: 0.8;
    background-color: var(--text-primary);
  }

  /* Mobile inline TOC */
  .toc-mobile .toc-container {
    display: block;
    position: relative;
    width: 100%;
    left: 0;
    opacity: 1;
    padding: 0;
  }

  .toc-mobile .toc-link {
    height: auto;
    font-size: var(--font-size-s);
    text-indent: 0;
    color: var(--text-secondary);
    padding: 0.25rem 0;
    line-height: 1.5;
  }

  .toc-mobile .toc-link::before,
  .toc-mobile .toc-link::after {
    display: none;
  }

  .toc-mobile .toc-link.active {
    color: var(--text-primary);
  }

  .toc-mobile .toc-level-3 .toc-link {
    padding-left: 0.5rem;
  }

  .toc-mobile .toc-level-4 .toc-link {
    padding-left: 1rem;
  }

  .toc-mobile .toc-level-5 .toc-link {
    padding-left: 1.5rem;
  }

  .toc-mobile .toc-level-6 .toc-link {
    padding-left: 2rem;
  }

  @media (prefers-reduced-motion: reduce) {
    .toc-container {
      transition: none;
    }

    .toc-link {
      transition: none;
    }

    .toc-link::after {
      transition: none;
    }

    .toc-level-1 .toc-link::before,
    .toc-level-2 .toc-link::before,
    .toc-level-3 .toc-link::before,
    .toc-level-4 .toc-link::before,
    .toc-level-5 .toc-link::before,
    .toc-level-6 .toc-link::before {
      transition: none;
    }
  }
</style>
