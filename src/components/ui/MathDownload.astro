---
import { Check, Download } from "@lucide/astro";
---

<template id="download-icons-template">
  <Download class="download-icon" size={16} />
  <Check class="downloaded-icon" size={16} />
</template>

<template id="download-menu-template">
  <div class="download-menu">
    <button type="button" class="download-menu-item" data-format="svg">SVG</button>
    <button type="button" class="download-menu-item" data-format="png">PNG</button>
  </div>
</template>

<script>
  function initMathDownload() {
    const template = document.getElementById('download-icons-template')
    const menuTemplate = document.getElementById('download-menu-template')
    const downloadButtons = document.querySelectorAll('.download-button')

    downloadButtons.forEach((button) => {
      if (button.dataset.downloadInit) return
      button.dataset.downloadInit = '1'

      if (!button.querySelector('svg') && template) {
        const icons = template.content.cloneNode(true)
        button.appendChild(icons)
      }

      let mathBlock = button.closest('.download-math-block')
      if (!mathBlock) {
        const parent = button.parentElement
        if (parent) {
          mathBlock = parent.querySelector('.download-math-block')
        }
      }
      if (!mathBlock) return

      const svgElement = mathBlock.querySelector('svg')
      if (!svgElement) return

      let container = mathBlock
      const parent = button.parentElement
      if (parent && parent.classList.contains('download-math-wrapper')) {
        container = parent
      }

      let menu = null

      container.addEventListener('mouseenter', () => {
        button.classList.add('visible')
      })

      container.addEventListener('mouseleave', () => {
        if (!button.hasAttribute('data-downloading')) {
          button.classList.remove('visible')
          if (menu) {
            menu.remove()
            menu = null
          }
        }
      })

      button.addEventListener('click', (e) => {
        e.stopPropagation()

        if (menu) {
          menu.remove()
          menu = null
          return
        }

        if (menuTemplate) {
          menu = menuTemplate.content.cloneNode(true).firstElementChild
          button.parentElement.appendChild(menu)

          menu.querySelectorAll('.download-menu-item').forEach((item) => {
            item.addEventListener('click', async (e) => {
              e.stopPropagation()
              const format = item.dataset.format

              button.setAttribute('data-downloading', 'true')

              try {
                const { downloadSvg } = await import('@/utils/svg-to-image')
                const { createDownloadFilename } = await import('@/utils/download-filename')

                await downloadSvg(svgElement, createDownloadFilename('equation'), format)

                button.classList.add('downloaded')

                if (menu) {
                  menu.remove()
                  menu = null
                }

                setTimeout(() => {
                  if (!container.matches(':hover')) {
                    button.classList.remove('visible')
                  }
                  button.removeAttribute('data-downloading')

                  setTimeout(() => {
                    button.classList.remove('downloaded')
                  }, 500)
                }, 1500)
              } catch (err) {
                console.error('Failed to download equation:', err)
                button.removeAttribute('data-downloading')
                if (menu) {
                  menu.remove()
                  menu = null
                }
              }
            })
          })
        }
      })

      document.addEventListener('click', () => {
        if (menu) {
          menu.remove()
          menu = null
        }
      })
    })
  }

  document.addEventListener('astro:page-load', initMathDownload)
  document.addEventListener('DOMContentLoaded', initMathDownload)
</script>

<style is:inline>
  .download-math-wrapper {
    position: relative !important;
  }

  .download-math-block {
    position: relative !important;
  }

  .download-button {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    width: 2rem;
    height: 2rem;
    z-index: 10;
    background: var(--bg);
    border-radius: 0.375rem;
    font-size: 0.75rem;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.15s ease-out;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--border);
    backdrop-filter: blur(48px);
    opacity: 0;
  }

  .download-button.visible,
  .download-button:focus,
  .download-button:focus-visible {
    opacity: 1;
  }

  .download-button::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--code-bg);
    border-radius: 0.325rem;
    opacity: 0;
    transition: opacity 0.15s ease-out;
    pointer-events: none;
  }

  .download-button:hover::before {
    opacity: 1;
  }

  .download-button:hover {
    color: var(--text-primary);
  }

  .download-button:focus,
  .download-button:focus-visible {
    outline: 2px solid var(--focus);
    outline-offset: 2px;
    color: var(--text-primary);
  }

  .download-button svg {
    flex-shrink: 0;
    position: relative;
    z-index: 1;
  }

  .download-button .downloaded-icon {
    display: none;
  }

  .download-button.downloaded .download-icon {
    display: none;
  }

  .download-button.downloaded .downloaded-icon {
    display: block;
  }

  .download-menu {
    position: absolute;
    top: 2.75rem;
    right: 0.5rem;
    z-index: 20;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 0.375rem;
    overflow: hidden;
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
  }

  .download-menu-item {
    display: block;
    width: 100%;
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    color: var(--text-secondary);
    background: transparent;
    border: none;
    cursor: pointer;
    text-align: left;
    transition: all 0.15s ease-out;
  }

  .download-menu-item:hover {
    background: var(--code-bg);
    color: var(--text-primary);
  }

  .download-menu-item:focus,
  .download-menu-item:focus-visible {
    outline: none;
    background: var(--code-bg);
    color: var(--text-primary);
  }

  @media (prefers-reduced-motion: reduce) {
    .download-button {
      transition: none;
    }

    .download-button::before {
      transition: none;
    }

    .download-menu-item {
      transition: none;
    }
  }
</style>
