---
import { pwaAssetsHead } from "virtual:pwa-assets/head";
import { pwaInfo } from "virtual:pwa-info";
// Import the global.css file here so that it is included on
// all pages through the use of the <BaseHead /> component.
import { themeConfig } from "@/config";
import {
	defaultLocale,
	getLanguageTag,
	getLocalizedPath,
	locales,
} from "@/i18n";
import type { BaseHeadProps } from "@/types/component.types";

const canonicalURL = new URL(Astro.url.pathname, Astro.site);

const {
	title,
	description,
	ogImage,
	locale = defaultLocale,
} = Astro.props as BaseHeadProps;
const imageUrl = ogImage
	? new URL(ogImage, Astro.url)
	: new URL("/og/chiri-og.png", Astro.url);

// Build alternate URLs for hreflang
const currentPath = Astro.url.pathname;
const alternateUrls = locales.map((loc) => ({
	locale: loc,
	url: new URL(getLocalizedPath(currentPath, loc), Astro.site),
	hreflang: getLanguageTag(loc),
}));

// Build locale-aware feed URLs
const feedPrefix = locale === defaultLocale ? "" : `/${locale}`;
const rssUrl = new URL(`${feedPrefix}/rss.xml`, Astro.site);
const atomUrl = new URL(`${feedPrefix}/atom.xml`, Astro.site);
---

<!-- Global Metadata -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />

<!-- PWA Assets (auto-generated icons and theme-color) -->
{pwaAssetsHead.themeColor && (
	<meta name="theme-color" content={pwaAssetsHead.themeColor.content} id="theme-color-meta" />
)}
{pwaAssetsHead.links.map((link) => (
	<link {...link} />
))}

<!-- PWA Manifest (from virtual module) -->
{pwaInfo && <Fragment set:html={pwaInfo.webManifest.linkTag} />}

<link rel="preload" href="/fonts/inter/inter-normal-latin.woff2" as="font" type="font/woff2" crossorigin="anonymous" />
<link rel="preload" href="/fonts/firacode/firacode-latin.woff2" as="font" type="font/woff2" crossorigin="anonymous" />
<link rel="sitemap" href="/sitemap-index.xml" />
<link
  rel="alternate"
  type="application/rss+xml"
  title={`${themeConfig.site.title} RSS Feed`}
  href={rssUrl}
/>
<link
  rel="alternate"
  type="application/atom+xml"
  title={`${themeConfig.site.title} Atom Feed`}
  href={atomUrl}
/>

<!-- Webmention -->
<link rel="webmention" href="https://webmention.io/jefrydco.id/webmention" />
<link rel="pingback" href="https://webmention.io/jefrydco.id/xmlrpc" />

<meta name="generator" content={Astro.generator} />

<!-- Canonical URL -->
<link rel="canonical" href={canonicalURL} />

<!-- Alternate language versions -->
{alternateUrls.map(({ hreflang, url }) => <link rel="alternate" hreflang={hreflang} href={url} />)}
<link rel="alternate" hreflang="x-default" href={new URL(getLocalizedPath(currentPath, defaultLocale), Astro.site)} />

<!-- Primary Meta Tags -->
<title>
  {title || themeConfig.site.title}
</title>
<meta name="title" content={title} />
<meta name="description" content={description} />

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website" />
<meta property="og:url" content={Astro.url} />
<meta property="og:title" content={title} />
<meta property="og:description" content={description} />
<meta property="og:image" content={imageUrl} />
<meta property="fb:admins" content="100003000286186" />
<meta property="fb:app_id" content="267913173658573" />
<meta property="fb:pages" content="632770976865033" />

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:url" content={Astro.url} />
<meta property="twitter:title" content={title} />
<meta property="twitter:description" content={description} />
<meta property="twitter:image" content={imageUrl} />
<meta name="twitter:site" content="@jefrydco" />
<meta name="twitter:creator" content="@jefrydco" />

<!-- Mastodon -->
<meta name="fediverse:creator" content="@jefrydco@mastodon.social">

<link rel="preconnect" href="https://www.googletagmanager.com" crossorigin />
<link rel="preconnect" href="https://www.google-analytics.com" crossorigin />

<script is:inline>
  (function() {
    var GA_ID = 'G-TGN6FFKR2D';
    var IDLE_TIMEOUT_MS = 5000;
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    window.gtag = gtag;
    gtag('js', new Date());
    gtag('config', GA_ID);

    var loaded = false;
    function loadGA() {
      if (loaded) return;
      loaded = true;
      var s = document.createElement('script');
      s.async = true;
      s.src = 'https://www.googletagmanager.com/gtag/js?id=' + GA_ID;
      document.head.appendChild(s);
    }

    ['scroll', 'pointerdown', 'keydown', 'touchstart'].forEach(function(evt) {
      window.addEventListener(evt, loadGA, { once: true, passive: true });
    });

    if ('requestIdleCallback' in window) {
      requestIdleCallback(loadGA, { timeout: IDLE_TIMEOUT_MS });
    } else {
      setTimeout(loadGA, IDLE_TIMEOUT_MS);
    }
  })();
</script>