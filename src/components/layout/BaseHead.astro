---
import { pwaAssetsHead } from "virtual:pwa-assets/head";
import { pwaInfo } from "virtual:pwa-info";
// Import the global.css file here so that it is included on
// all pages through the use of the <BaseHead /> component.
import { themeConfig } from "@/config";
import {
	defaultLocale,
	getLanguageTag,
	getLocalizedPath,
	locales,
} from "@/i18n";
import type { BaseHeadProps } from "@/types/component.types";

const canonicalURL = new URL(Astro.url.pathname, Astro.site);

const {
	title,
	description,
	ogImage,
	locale = defaultLocale,
	feedSection,
} = Astro.props as BaseHeadProps;
const imageUrl = ogImage
	? new URL(ogImage, Astro.url)
	: new URL("/og/chiri-og.png", Astro.url);

// Build alternate URLs for hreflang
const currentPath = Astro.url.pathname;
const alternateUrls = locales.map((loc) => ({
	locale: loc,
	url: new URL(getLocalizedPath(currentPath, loc), Astro.site),
	hreflang: getLanguageTag(loc),
}));

// Build locale-aware feed URLs (only when feedSection is provided)
const feedPrefix = locale === defaultLocale ? "" : `/${locale}`;
const rssUrl = feedSection ? new URL(`${feedPrefix}/${feedSection}/rss.xml`, Astro.site) : null;
const atomUrl = feedSection ? new URL(`${feedPrefix}/${feedSection}/atom.xml`, Astro.site) : null;
---

<!-- Global Metadata -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />

<!-- PWA Assets (auto-generated icons and theme-color) -->
{pwaAssetsHead.themeColor && (
	<meta name="theme-color" content={pwaAssetsHead.themeColor.content} id="theme-color-meta" />
)}
{pwaAssetsHead.links.map((link) => (
	<link {...link} />
))}

<!-- PWA Manifest (from virtual module) -->
{pwaInfo && <Fragment set:html={pwaInfo.webManifest.linkTag} />}

<link rel="preload" href="/fonts/inter/inter-normal-latin.woff2" as="font" type="font/woff2" crossorigin="anonymous" />
<link rel="preload" href="/fonts/firacode/firacode-latin.woff2" as="font" type="font/woff2" crossorigin="anonymous" />
<link rel="sitemap" href="/sitemap-index.xml" />
<link rel="author" type="text/plain" href="/humans.txt" />
{rssUrl && (
  <link
    rel="alternate"
    type="application/rss+xml"
    title={`${themeConfig.site.title} RSS Feed`}
    href={rssUrl}
  />
)}
{atomUrl && (
  <link
    rel="alternate"
    type="application/atom+xml"
    title={`${themeConfig.site.title} Atom Feed`}
    href={atomUrl}
  />
)}

<!-- Webmention -->
<link rel="webmention" href="https://webmention.io/jefrydco.id/webmention" />
<link rel="pingback" href="https://webmention.io/jefrydco.id/xmlrpc" />

<meta name="generator" content={Astro.generator} />

<!-- Canonical URL -->
<link rel="canonical" href={canonicalURL} />

<!-- Alternate language versions -->
{alternateUrls.map(({ hreflang, url }) => <link rel="alternate" hreflang={hreflang} href={url} />)}
<link rel="alternate" hreflang="x-default" href={new URL(getLocalizedPath(currentPath, defaultLocale), Astro.site)} />

<!-- Primary Meta Tags -->
<title>
  {title || themeConfig.site.title}
</title>
<meta name="title" content={title} />
<meta name="description" content={description} />

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website" />
<meta property="og:url" content={Astro.url} />
<meta property="og:title" content={title} />
<meta property="og:description" content={description} />
<meta property="og:image" content={imageUrl} />
<meta property="fb:admins" content="100003000286186" />
<meta property="fb:app_id" content="267913173658573" />
<meta property="fb:pages" content="632770976865033" />

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:url" content={Astro.url} />
<meta property="twitter:title" content={title} />
<meta property="twitter:description" content={description} />
<meta property="twitter:image" content={imageUrl} />
<meta name="twitter:site" content="@jefrydco" />
<meta name="twitter:creator" content="@jefrydco" />

<!-- Mastodon -->
<meta name="fediverse:creator" content="@jefrydco@mastodon.social">

<script defer src="https://cloud.umami.is/script.js" data-website-id="3b3c7f52-a843-4f74-9ed4-add36cec1376"></script>